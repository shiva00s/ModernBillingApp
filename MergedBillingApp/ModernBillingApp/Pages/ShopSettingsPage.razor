@page "/shop-settings"
@inject SettingsService settingsService
@inject NavigationManager navManager
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms

<h3>Shop Details & Settings</h3>
<p>Update your shop's information here. This will be used on all printed bills.</p>

<div class="card shadow col-md-8">
    <div class="card-body">
        <EditForm Model="@settings" OnValidSubmit="HandleSave">
            <DataAnnotationsValidator />
            
            <div class="mb-3">
                <label class="form-label">Shop Name</label>
                <InputText @bind-value="settings.ShopName" class="form-control" />
                <ValidationMessage For="@(() => settings.ShopName)" />
            </div>
            
            <div class="mb-3">
                <label class="form-label">Address</label>
                <InputTextArea @bind-value="settings.Address" class="form-control" rows="3" />
            </div>

            <div class="mb-3">
                <label class="form-label">Contact Number</label>
                <InputText @bind-value="settings.ContactNumber" class="form-control" />
            </div>
            
            <div class="mb-3">
                <label class="form-label">GST Number</label>
                <InputText @bind-value="settings.GstNumber" class="form-control" />
            </div>

            <div class="mb-3">
                <label class="form-label">Shop Logo</label>
                <InputFile OnChange="LoadLogo" class="form-control" />
                @if (settings.Logo != null)
                {
                    <img src="@($"data:image/png;base64,{Convert.ToBase64String(settings.Logo)}")" class="mt-2" style="max-height: 100px;" />
                }
            </div>

            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success">@successMessage</div>
            }

            <button type="submit" class="btn btn-success">Save Settings</button>
        </EditForm>
    </div>
</div>

@code {
    private ShopSettings settings = new ShopSettings();
    private string successMessage = "";

    protected override async Task OnInitializedAsync()
    {
        settings = await settingsService.GetSettings();
    }

    private async Task LoadLogo(InputFileChangeEventArgs e)
    {
        var file = e.File;
        var buffer = new byte[file.Size];
        await file.OpenReadStream().ReadAsync(buffer);
        settings.Logo = buffer;
        successMessage = ""; // Clear message
    }

    private async Task HandleSave()
    {
        await settingsService.SaveSettings(settings);
        successMessage = "Settings saved successfully!";
    }
}