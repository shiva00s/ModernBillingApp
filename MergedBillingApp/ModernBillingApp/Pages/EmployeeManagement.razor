@page "/employee-management"
@inject EmployeeService empService
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms

<h3>Employee Management</h3>

<div class="row">
    <div class="col-md-8">
        <h5>Current Employees</h5>
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Emp. No</th>
                    <th>Name</th>
                    <th>Mobile</th>
                    <th>Job Type</th>
                    <th>Salary</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (employeeList == null)
                {
                    <tr><td colspan="6">Loading...</td></tr>
                }
                else
                {
                    @foreach (var emp in employeeList)
                    {
                        <tr @onclick="() => SelectEmployee(emp)" style="cursor:pointer">
                            <td>@emp.EmpNo</td>
                            <td>@emp.EmpName</td>
                            <td>@emp.EmpMobile</td>
                            <td>@emp.Job_Type</td>
                            <td>@emp.Salary?.ToString("0.00")</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => SelectEmployee(emp)">
                                    Edit
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header">
                <h5>@formTitle</h5>
            </div>
            <div class="card-body">
                <EditForm Model="@editModel" OnValidSubmit="HandleSave">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-2">
                        <label class="form-label">Employee No</label>
                        <InputText @bind-Value="editModel.EmpNo" class="form-control" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Name</label>
                        <InputText @bind-Value="editModel.EmpName" class="form-control" />
                        <ValidationMessage For="@(() => editModel.EmpName)" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Mobile</label>
                        <InputText @bind-Value="editModel.EmpMobile" class="form-control" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Job Type</label>
                        <InputText @bind-Value="editModel.Job_Type" class="form-control" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Salary</label>
                        <InputNumber @bind-Value="editModel.Salary" class="form-control" />
                    </div>
                    
                    <hr />
                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="ClearSelection">New</button>
                    
                    @if (editModel.Id != 0)
                    {
                        <button type="button" class="btn btn-danger" @onclick="HandleDelete">Delete</button>
                    }
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Employee> employeeList = new List<Employee>();
    private EmployeeEditModel editModel = new EmployeeEditModel();
    private string formTitle = "Create New Employee";
    private int selectedEmployeeId = 0;

    // A helper class for form validation
    public class EmployeeEditModel
    {
        public int Id { get; set; }
        public string? EmpNo { get; set; }
        [Required(ErrorMessage = "Employee name is required.")]
        public string EmpName { get; set; } = "";
        public string? EmpMobile { get; set; }
        public string? Job_Type { get; set; }
        public double? Salary { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        employeeList = await empService.GetEmployees();
        StateHasChanged(); // Refresh the UI
    }

    private void SelectEmployee(Employee emp)
    {
        selectedEmployeeId = emp.Id;
        editModel = new EmployeeEditModel
        {
            Id = emp.Id,
            EmpNo = emp.EmpNo,
            EmpName = emp.EmpName ?? "",
            EmpMobile = emp.EmpMobile,
            Job_Type = emp.Job_Type,
            Salary = emp.Salary
        };
        formTitle = $"Edit Employee: {emp.EmpName}";
    }

    private void ClearSelection()
    {
        selectedEmployeeId = 0;
        editModel = new EmployeeEditModel();
        formTitle = "Create New Employee";
    }

    private async Task HandleSave()
    {
        // Convert the EditModel back to the full Employee model
        Employee empToSave = new Employee
        {
            Id = selectedEmployeeId,
            EmpNo = editModel.EmpNo,
            EmpName = editModel.EmpName,
            EmpMobile = editModel.EmpMobile,
            Job_Type = editModel.Job_Type,
            Salary = editModel.Salary
        };

        if (selectedEmployeeId == 0) // New Employee
        {
            await empService.CreateEmployee(empToSave);
        }
        else // Existing Employee
        {
            await empService.UpdateEmployee(empToSave);
        }
        
        ClearSelection();
        await LoadData();
    }

    private async Task HandleDelete()
    {
        if(selectedEmployeeId == 0) return;
        
        await empService.DeleteEmployee(selectedEmployeeId);
        ClearSelection();
        await LoadData();
    }
}