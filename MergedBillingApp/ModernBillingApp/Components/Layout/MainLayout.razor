@inherits LayoutComponentBase
@namespace ModernBillingApp.Components.Layout
@using ModernBillingApp.Services
@inject SessionService SessionService
@inject ThemeService ThemeService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@implements IDisposable

@if (SessionService.IsAuthenticated)
{
    <div class="page @(ThemeService.IsDarkMode ? "dark-theme" : "light-theme")">
        <div class="sidebar">
            <NavMenu />
        </div>

        <main>
            <div class="top-row px-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary btn-sm me-2" @onclick="ToggleSidebar" title="Toggle Sidebar">
                        <i class="bi bi-list"></i>
                    </button>
                    <span class="text-muted me-3 d-none d-md-block">@DateTime.Now.ToString("MMM dd, yyyy HH:mm")</span>
                    <h5 class="mb-0 text-muted d-none d-md-block">@GetPageTitle()</h5>
                </div>

                <div class="d-flex align-items-center">
                    <!-- Theme Toggle -->
                    <button class="btn btn-outline-secondary btn-sm me-2" @onclick="ToggleTheme" title="Toggle Theme">
                        <i class="bi @(ThemeService.IsDarkMode ? "bi-sun" : "bi-moon")"></i>
                    </button>

                    <!-- Notifications -->
                    <NotificationBell />

                    <!-- User Menu -->
                    <div class="dropdown me-3">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i>
                            @SessionService.CurrentUser?.Username
                            @if (SessionService.IsAdmin)
                            {
                                <span class="badge bg-primary ms-1">Admin</span>
                            }
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="/shopsettingspage"><i class="bi bi-gear me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item text-danger" @onclick="HandleLogout"><i class="bi bi-box-arrow-right me-2"></i>Logout</button></li>
                        </ul>
                    </div>
                </div>
            </div>

            <article class="content px-4">
                @Body
            </article>
        </main>
    </div>

    <ToastNotification @ref="toastNotification" />
}
else
{
    <div class="unauthorized-container">
        <div class="unauthorized-content">
            <h3><i class="bi bi-exclamation-triangle"></i> Access Denied</h3>
            <p>You need to be logged in to access this page.</p>
            <a href="/login" class="btn btn-primary">Go to Login</a>
        </div>
    </div>
}

<div id="blazor-error-ui" class="@(ThemeService.IsDarkMode ? "dark-theme" : "")">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">ðŸ—™</a>
</div>

@code {
    private Components.ToastNotification? toastNotification;
    private bool sidebarCollapsed = false;
    private int unreadNotificationCount = 0; // Keeping this for potential future use or if NotificationBell needs it

    protected override async Task OnInitializedAsync()
    {
        ThemeService.ThemeChanged += OnThemeChanged;

        if (!SessionService.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login", forceLoad: true);
            return;
        }

        SessionService.OnAuthenticationChanged += StateHasChanged;

        if (SessionService.CurrentUserId.HasValue)
        {
            unreadNotificationCount = await NotificationService.GetUnreadNotificationCountAsync(SessionService.CurrentUserId.Value);
        }
    }

    private void OnThemeChanged(string theme)
    {
        InvokeAsync(StateHasChanged);
    }

    private void ToggleTheme()
    {
        ThemeService.SetTheme(ThemeService.IsDarkMode ? "light" : "dark");
    }

    private void ToggleSidebar()
    {
        sidebarCollapsed = !sidebarCollapsed;
        StateHasChanged();
    }

    private string GetPageTitle()
    {
        var uri = new Uri(NavigationManager.Uri);
        var path = uri.AbsolutePath.TrimStart('/');

        return path switch
        {
            "" or "index" or "dashboard" => "Dashboard",
            "billingpage" => "Billing",
            "cashentry" => "Cash Entry",
            "customermanagement" => "Customer Management",
            "suppliermanagement" => "Supplier Management",
            "productcatalog" => "Product Management",
            "employeemanagement" => "Staff Management",
            "salesreports" or "customerreport" or "profitreporttab" or "saleslogtab" or "stockreport" => "Reports",
            "shopsettingspage" => "Settings",
            "usermanagement" => "User Management",
            "expenses" => "Expenses",
            "stockin" => "Stock In",
            "stockreturnpage" => "Stock Return",
            _ => "Modern Billing App"
        };
    }

    private void HandleLogout()
    {
        SessionService.ClearUser();
        NavigationManager.NavigateTo("/login", forceLoad: true);
    }

    public void Dispose()
    {
        SessionService.OnAuthenticationChanged -= StateHasChanged;
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}

<style>
    .loading-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .sidebar.collapsed {
        margin-left: -250px; /* Adjust if sidebar width is different */
    }

    .unauthorized-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .unauthorized-content {
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        padding: 2rem;
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }
</style>
