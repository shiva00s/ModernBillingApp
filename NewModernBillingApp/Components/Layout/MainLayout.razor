@inherits LayoutComponentBase
@namespace NewModernBillingApp.Components.Layout
@using NewModernBillingApp.Services
@inject SessionService sessionService
@inject ThemeService themeService
@inject NotificationService notificationService
@inject NavigationManager navigation
@implements IDisposable

@if (sessionService.IsLoggedIn)
{
    <div class="page @(themeService.IsDarkMode ? "dark-theme" : "light-theme")">
        <div class="sidebar">
            <NavMenu />
        </div>

        <main>
            <div class="top-row px-3 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary btn-sm me-2" @onclick="ToggleSidebar">
                        <i class="bi bi-list"></i>
                    </button>
                    <h5 class="mb-0 text-muted">@GetPageTitle()</h5>
                </div>

                <div class="d-flex align-items-center">
                    <!-- Theme Toggle -->
                    <button class="btn btn-outline-secondary btn-sm me-2" @onclick="ToggleTheme" title="Toggle Theme">
                        <i class="bi @(themeService.IsDarkMode ? "bi-sun" : "bi-moon")"></i>
                    </button>

                    <!-- Notifications -->
                    <NotificationBell />

                    <!-- User Menu -->
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>@sessionService.CurrentUserName
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="/settings"><i class="bi bi-gear me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item" @onclick="Logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</button></li>
                        </ul>
                    </div>
                </div>
            </div>

            <article class="content px-4">
                @Body
            </article>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>
}
else
{
    <div class="unauthorized-container">
        <div class="unauthorized-content">
            <h3><i class="bi bi-exclamation-triangle"></i> Access Denied</h3>
            <p>You need to be logged in to access this page.</p>
            <a href="/login" class="btn btn-primary">Go to Login</a>
        </div>
    </div>
}

<div id="blazor-error-ui" class="@(themeService.IsDarkMode ? "dark-theme" : "")">
    An error has occurred. This application may no longer respond until reloaded.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">ðŸ—™</a>
</div>

@code {
    private bool sidebarCollapsed = false;
    private int unreadNotificationCount = 0;

    protected override async Task OnInitializedAsync()
    {
        themeService.ThemeChanged += OnThemeChanged;

        if (sessionService.CurrentUserId.HasValue)
        {
            unreadNotificationCount = await notificationService.GetUnreadNotificationCountAsync(sessionService.CurrentUserId.Value);
        }
    }

    private void OnThemeChanged(string theme)
    {
        InvokeAsync(StateHasChanged);
    }

    private void ToggleTheme()
    {
        themeService.SetTheme(themeService.IsDarkMode ? "light" : "dark");
    }

    private void ToggleSidebar()
    {
        sidebarCollapsed = !sidebarCollapsed;
        StateHasChanged();
    }

    private string GetPageTitle()
    {
        var uri = new Uri(navigation.Uri);
        var path = uri.AbsolutePath.TrimStart('/');

        return path switch
        {
            "" or "dashboard" => "Dashboard",
            "billing" => "Billing",
            "cash-entry" => "Cash Entry",
            "customers" => "Customer Management",
            "suppliers" => "Supplier Management",
            "products" => "Product Management",
            "staff" => "Staff Management",
            "reports" => "Reports",
            "settings" => "Settings",
            "users" => "User Management",
            _ => "Modern Billing App"
        };
    }

    private async Task Logout()
    {
        sessionService.ClearCurrentUser();
        navigation.NavigateTo("/", true);
    }

    public void Dispose()
    {
        themeService.ThemeChanged -= OnThemeChanged;
    }
}

<style>
    .loading-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .sidebar.collapsed {
        margin-left: -250px;
    }

    .toast-container {
        z-index: 1055;
    }

    .unauthorized-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .unauthorized-content {
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        padding: 2rem;
        border-radius: 10px;
        backdrop-filter: blur(10px);
    }
</style>
