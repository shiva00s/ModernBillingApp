@page "/expenses"
@inject ExpenseService expenseService
@using ModernBillingApp.Models
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms

<h3>Income & Expense Log</h3>
<p>Log miscellaneous cash income or expenses (e.g., rent, supplies).</p>

<div class="row">
    <div class="col-md-7">
        <h5>Recent Entries</h5>
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (entryList == null)
                {
                    <tr><td colspan="5">Loading...</td></tr>
                }
                else
                {
                    @foreach (var entry in entryList)
                    {
                        <tr @onclick="() => SelectEntry(entry)" style="cursor:pointer">
                            <td>@entry.Date.ToShortDateString()</td>
                            <td>@entry.CEName</td>
                            <td>
                                @if(entry.CEType == "Income")
                                {
                                    <span class="badge bg-success">Income</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Expense</span>
                                }
                            </td>
                            <td>@entry.Amount.ToString("0.00")</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => SelectEntry(entry)">
                                    Edit
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="col-md-5">
        <div class="card shadow">
            <div class="card-header">
                <h5>@formTitle</h5>
            </div>
            <div class="card-body">
                <EditForm Model="@editModel" OnValidSubmit="HandleSave">
                    <DataAnnotationsValidator />

                    <div class="mb-3">
                        <label class="form-label">Entry Name (e.g., "Office Rent")</label>
                        <InputText @bind-value="editModel.CEName" class="form-control" />
                        <ValidationMessage For="@(() => editModel.CEName)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <InputSelect @bind-value="editModel.CEType" class="form-select">
                            <option value="">-- Select Type --</option>
                            <option value="Income">Income</option>
                            <option value="Expense">Expense</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => editModel.CEType)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Amount</label>
                        <InputNumber @bind-value="editModel.Amount" class="form-control" />
                        <ValidationMessage For="@(() => editModel.Amount)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <InputText @bind-value="editModel.Remark" class="form-control" />
                    </div>

                    <hr />
                    <button type="submit" class="btn btn-success">Save Entry</button>
                    <button type="button" class="btn btn-secondary" @onclick="ClearSelection">New</button>

                    @if (selectedEntryId != 0)
                    {
                        <button type="button" class="btn btn-danger" @onclick="HandleDelete">Delete</button>
                    }
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private List<ModernBillingApp.Models.CashEntry> entryList = new List<ModernBillingApp.Models.CashEntry>();
    private CashEntryEditModel editModel = new CashEntryEditModel();
    private string formTitle = "Create New Entry";
    private int selectedEntryId = 0;

    // A helper class for form validation
    public class CashEntryEditModel
    {
        public int Id { get; set; }
        [Required]
        public string? CEName { get; set; }
        [Required]
        public string? CEType { get; set; }
        [Range(0.01, double.MaxValue, ErrorMessage = "Amount must be greater than 0.")]
        public decimal Amount { get; set; }
        public string? Remark { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        entryList = await expenseService.GetCashEntries();
        StateHasChanged(); // Refresh the UI
    }

    private void SelectEntry(ModernBillingApp.Models.CashEntry entry)
    {
        selectedEntryId = entry.Id;
        editModel = new CashEntryEditModel
        {
            Id = entry.Id,
            CEName = entry.CEName,
            CEType = entry.CEType,
            Amount = entry.Amount,
            Remark = entry.Remark
        };
        formTitle = $"Edit Entry: {entry.CEName}";
    }

    private void ClearSelection()
    {
        selectedEntryId = 0;
        editModel = new CashEntryEditModel();
        formTitle = "Create New Entry";
    }

    private async Task HandleSave()
    {
        ModernBillingApp.Models.CashEntry entryToSave = new ModernBillingApp.Models.CashEntry
        {
            Id = selectedEntryId,
            CEName = editModel.CEName,
            CEType = editModel.CEType,
            Amount = editModel.Amount,
            Remark = editModel.Remark,
            Date = DateTime.Now // Set date on save
        };

        if (selectedEntryId == 0) // New Entry
        {
            await expenseService.CreateCashEntry(entryToSave);
        }
        else // Existing Entry
        {
            await expenseService.UpdateCashEntry(entryToSave);
        }

        ClearSelection();
        await LoadData();
    }

    private async Task HandleDelete()
    {
        if(selectedEntryId == 0) return;

        await expenseService.DeleteCashEntry(selectedEntryId);
        ClearSelection();
        await LoadData();
    }
}
