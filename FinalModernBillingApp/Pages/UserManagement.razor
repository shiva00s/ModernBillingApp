@page "/user-management"
@inject UserService userService
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using ModernBillingApp.Models


<h3>User Management</h3>
<p>Create, edit, and manage application users and their roles.</p>

<div class="row">
    <div class="col-md-7">
        <h5>Current Users</h5>
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (userList == null)
                {
                    <tr><td colspan="4">Loading...</td></tr>
                }
                else
                {
                    @foreach (var user in userList)
                    {
                        <tr @onclick="() => SelectUser(user)" style="cursor:pointer">
                            <td>@user.Username</td>
                            <td>@user.Email</td>
                            <td>@user.Role?.RoleName</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => SelectUser(user)">
                                    Edit
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="col-md-5">
        <div class="card shadow">
            <div class="card-header">
                <h5>@formTitle</h5>
            </div>
            <div class="card-body">
                <EditForm Model="@editModel" OnValidSubmit="HandleSave">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <InputText @bind-Value="editModel.Username" class="form-control" />
                        <ValidationMessage For="@(() => editModel.Username)" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <InputText @bind-Value="editModel.Email" class="form-control" />
                        <ValidationMessage For="@(() => editModel.Email)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <InputSelect @bind-Value="editModel.UserRoleId" class="form-select">
                            <option value="0">-- Select Role --</option>
                            @if(roleList != null)
                            {
                                @foreach (var role in roleList)
                                {
                                    <option value="@role.Id">@role.RoleName</option>
                                }
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => editModel.UserRoleId)" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <InputText @bind-Value="editModel.Password" type="password" class="form-control" 
                                   placeholder="@(editModel.Id == 0 ? "Required" : "Leave blank to keep current password")" />
                        <ValidationMessage For="@(() => editModel.Password)" />
                    </div>

                    <button type="submit" class="btn btn-success">Save</button>
                    <button type="button" class="btn btn-secondary" @onclick="ClearSelection">New</button>
                    
                    @if (editModel.Id != 0)
                    {
                        <button type="button" class="btn btn-danger" @onclick="HandleDelete">Delete</button>
                    }
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private List<User> userList = new List<User>();
    private List<UserRole> roleList = new List<UserRole>();
    private UserEditModel editModel = new UserEditModel();
    private string formTitle = "Create New User";
    private int selectedUserId = 0;

    // Helper class for form validation
    public class UserEditModel
    {
        public int Id { get; set; }
        [Required]
        public string Username { get; set; } = "";
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";
        [Range(1, int.MaxValue, ErrorMessage = "Please select a role.")]
        public int UserRoleId { get; set; }
        public string? Password { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        userList = await userService.GetUsers();
        roleList = await userService.GetRoles();
        StateHasChanged(); // Refresh the UI
    }

    private void SelectUser(User user)
    {
        selectedUserId = user.Id;
        editModel = new UserEditModel
        {
            Id = user.Id,
            Username = user.Username,
            Email = user.Email,
            UserRoleId = user.UserRoleId
        };
        formTitle = $"Edit User: {user.Username}";
    }

    private void ClearSelection()
    {
        selectedUserId = 0;
        editModel = new UserEditModel();
        formTitle = "Create New User";
    }

    private async Task HandleSave()
    {
        // Validate password for new users
        if (selectedUserId == 0 && string.IsNullOrEmpty(editModel.Password))
        {
            // This is a simple validation, we can add more complex logic
            return; 
        }

        if (selectedUserId == 0) // New User
        {
            await userService.CreateUser(editModel.Username, editModel.Password!, editModel.Email, editModel.UserRoleId);
        }
        else // Existing User
        {
            await userService.UpdateUser(selectedUserId, editModel.Username, editModel.Email, editModel.UserRoleId, editModel.Password);
        }
        
        ClearSelection();
        await LoadData();
    }

    private async Task HandleDelete()
    {
        if(selectedUserId == 0) return;
        
        await userService.DeleteUser(selectedUserId);
        ClearSelection();
        await LoadData();
    }
}